<script src="/js/jquery-3.2.1.min.js"></script>
<script src="/js/jquery-ui.min.js"></script>
<script src="/js/moment.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/bootstrap-datetimepicker.min.js"></script>

<!--  <script src="js/seeds.js"></script> -->

<link rel="stylesheet" href="/css/jquery-ui.min.css">
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/bootstrap-theme2.css">
<link rel="stylesheet" href="/css/autocomplete.css">
<link rel="stylesheet" href="/css/mvms_visitors_style.css">
<body class="ltblueback">

<div id="main2" class="container">
  <% if request.get? %>


      <div hidden>
        <div id="face_detector_selection_control" class="row input-field" style="margin-right: 20px;">
          <select id="selectFaceDetector">
            <option value="ssd_mobilenetv1" selected>SSD Mobilenet V1</option>
            <option value="tiny_face_detector">Tiny Face Detector</option>
            <option value="mtcnn">MTCNN</option>
          </select>
          <label>Select Face Detector</label>
        </div>
        <!-- ssd_mobilenetv1_controls -->
        <span id="ssd_mobilenetv1_controls">
          <div class="row side-by-side">
            <div class="row">
              <label for="minConfidence">Min Confidence:</label>
              <input disabled value="0.5" id="minConfidence" type="text" class="bold">
            </div>
            <button
            class="waves-effect waves-light btn"
            onclick="onDecreaseMinConfidence()"
            >
              <i class="material-icons left">-</i>
            </button>
            <button
            class="waves-effect waves-light btn"
            onclick="onIncreaseMinConfidence()"
            >
              <i class="material-icons left">+</i>
            </button>
          </div>
        </span>
        <!-- ssd_mobilenetv1_controls -->

      </div>

      <form id="visitor_sign_form" autocomplete="off" method="post">
        <div class="form-group">

          <div id="capture_photo">
            <h1><a href='/'> <img class="smlogo" src="/images/microhealth-logo.svg" /></a></h1>
            <div class="complete_msg" id="capture_complete_msg">Must complete form!</div>
            <div class="row">
              <div class="col-xs-12 col-sm-12" >
                <div id="person_image_camera" style="width: 250px;height: 320px; overflow: hidden; margin: auto"> </div>
                <div id="person_image" style="width: 250px;height: 320px; overflow: hidden" hidden> </div>
              </div>
            </div>
            <div class="row" id="email_row" hidden>
              <div id="email_row_not_found" hidden> WE Coudn't find your email please add it manually</div>
              <div class="col-xs-12 col-sm-3 col-md-2">
                <label for="capture_person_name">Email:</label>
              </div>
              <div class="col-xs-12 col-sm-9 col-md-10">
                <input type="text" class="form-control" id="capture_person_name" name="name">
              </div>
              <div class="col-xs-12">
                <p><span id="capture_person_msg"></span></p>
              </div>
            </div>

            <div class="buttonrow">
              <a href="/" > <button class="btn btn-warning" > Cancel</button></a>
              <button id="capture_next_btn" class="btn btn-success">Next</button>
            </div>
          </div><!-- capture_photo  -->
        </div>
      </form>
      <canvas id="overlay" />
      <script>

          var classes = [];
          var visitors_emails = {};
          <% Visitor.where(visitor_visit_informations: {sign_out_date: nil}).each do |v| %>
            classes.push("<%= "visitor_#{v.id}"%>");
            visitors_emails['<%= "visitor_#{v.id}" %>'] = '<%=  v.email %>'
          <% end %>
          var faceMatcher = null
          //          const threshold = 0.6

          async function updateResults() {
              if (!isFaceDetectionModelLoaded()) {
                  return
              }
              const threshold = 0.6;
              const inputImgEl = $('#inputImg').get(0)

              desc2 = await
              faceapi.computeFaceDescriptor(inputImgEl);

              found = false;
              for (i = 0; i < faceMatcher['_labeledDescriptors'].length; i++) {
                  desc1 = faceMatcher['_labeledDescriptors'][i]['_descriptors'][0]
                  distance = faceapi.round(faceapi.euclideanDistance(desc1, desc2)
                  )
                  if (distance <= threshold) {
                      console.log(faceMatcher['_labeledDescriptors'][i]['_label'])
                      found = true;
                      $('#capture_person_name').val(visitors_emails[faceMatcher['_labeledDescriptors'][i]['_label']])
                      break;
                  }

              }
              $('#email_row').show()
              if(!found)
              {
                  $('#email_row_not_found').show()
              }
          }

          function drawFaceRecognitionResults(results) {
              const canvas = $('#overlay').get(0)
              // resize detection and landmarks in case displayed image is smaller than
              // original size
              resizedResults = resizeCanvasAndResults($('#inputImg').get(0), canvas, results)

              const boxesWithText = resizedResults.map(({ detection, descriptor }) =>
                  new faceapi.BoxWithText(
                      detection.box,
                      faceMatcher.findBestMatch(descriptor).toString()
                  )
          )
              faceapi.drawDetection(canvas, boxesWithText)
          }

          async function run() {
              // load face detection, face landmark model and face recognition models
              await changeFaceDetector(selectedFaceDetector)
              await faceapi.loadFaceLandmarkModel('/')
              await faceapi.loadFaceRecognitionModel('/')

//        // initialize face matcher with 1 reference descriptor per bbt character
              faceMatcher = await createBbtFaceMatcher(1)

              console.log(faceMatcher)

          }

          function initWebCam() {
              picked_photo = false;
              // init_face_api()
              $("#signin_capture_msg").show();
              $("#signin_check_visit").show();
              $("#signout_capture_msg").hide();

              iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream
              if (iOS) {
                  Webcam.set({
                      width: 280,
                      constraints: {facingMode: {exact: "user"}},
                      height: 300,
                      dest_width: 280,
                      dest_height: 300,
                      image_format: 'png',
                      jpeg_quality: 90,
                      user_callback: function (data_uri) {
                          // display results in page

                          document.getElementById('person_image').innerHTML = '<img id="inputImg" src="' + data_uri + '"/>';
                          $('#person_image_camera').hide();
                          $('#person_image').show();
                          picked_photo = true;
                          updateResults()
                      }
                  });

              }

              else {
                  Webcam.set({
                      width: 280,
                      height: 300,
                      dest_width: 280,
                      dest_height: 300,
                      image_format: 'jpeg',
                      jpeg_quality: 180
                  });
                  $('#person_image_camera').on('click', function () {
                      $('#person_image_camera').hide()
                      Webcam.snap(function (data_uri) {
                          // display results in page
                          document.getElementById('person_image').innerHTML = '<img  id="inputImg" src="' + data_uri + '"/>';
                          picked_photo = true;
                      });
                      $('#person_image').show();
                      updateResults()
                  })
              }


              Webcam.attach('#person_image_camera');

              $("#capture_photo").show();

          }
          $(document).ready(function() {
              initFaceDetectionControls()
              run();
              initWebCam()
          })

      </script>
      <script src="/js/webcam.min.js" type="text/javascript"></script>
      <script src="/js/face-api.js"></script>
      <script src="/js/commons.js"></script>
      <script src="/js/drawing.js"></script>
      <script src="/js/faceDetectionControls.js"></script>
      <script src="/js/imageSelectionControls.js"></script>
      <script src="/js/bbt.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>

      <script>
          $(document).ready(function(){
              $(document).keypress(function(e) {
                  var keycode = (e.keyCode ? e.keyCode : e.which);
                  if (keycode == '13') {
                      $('#capture_next_btn').trigger('click')
                  }
              });
          })
      </script>
  <% else %>
      <!-- ********************************************************************************************  -->
      <div id="visit_summary">
        <h1><a href='/'> <img class="smlogo" src="/images/microhealth-logo.svg" /></a></h1>
        <h2>Visit Summary</h2>
        <div id="missed_signout_msg">You forgot to sign out of your last visit. Please sign out before signing in.</div>

        <div class="row firstelement">
          <div class="col-xs-4 col-sm-4 col-md-3" id="display_photo_div">
            <img src="<%= @visitor.avatar %>" width="250px" style="float: left"/>
          </div>
          <div class="col-xs-8 col-sm-8 col-md-9" id="person_info" >
            <table style="float: right;">
              <tr>
                <td>Name:</td><td><span id="display_name"><%= @visitor.name %></span></td>
              </tr>
              <tr>
                <td>Company:</td><td><span id="display_company"><%= @visitor.company.try(:name) %></span></td>
              </tr>
              <tr>
                <td>Phone:</td><td><span id="display_phone"><%= @visitor.phone %></span></td>
              </tr>
              <tr>
                <td>Email:</td><td><span id="display_email"><%= @visitor.email %></span></td>
              </tr>
              <tr>
                <td>Visit Reason:</td><td><span id="display_reason"><%= @visitor.last_visit.visit_reason %></span></td>
              </tr>
              <tr>
                <td>Person Visiting:&nbsp;&nbsp;&nbsp;</td><td><span id="display_personvisit"><%= @visitor.last_visit.person.try(:name) %></span></td>
              </tr>
              <tr>
                <td>US Citizen:</td><td><span id="display_citizen"><%= @visitor.us_citizen? %></span></td>
              </tr>
              <tr>
                <td>Classified:</td><td><span id="display_classified"><%= @visitor.last_visit.classified? %></span></td>
              </tr>
            </table>
          </div>
        </div>

        <div class="row" id="display_date_div">
          <div class="col-xs-12 col-sm-6">
            <p>Date: <span id="display_date_in"><%= @visitor.last_visit.sign_in_date.try(:sign_in_date) %></span></p>
          </div>
          <div class="col-xs-12 col-sm-6">
            <p>Time In: <span id="display_time_in"><%= @visitor.last_visit.strftime('%I:%M %p') rescue nil%></span></p>
          </div>
        </div>

        <div class="buttonrow">
          <%= link_to 'Back', root_path, class: "btn btn-info" %>
          <%= link_to 'Sign Out', visitor_signout_path(visitor_id: @visitor.id), class: "btn btn-success" %>
        </div>

      </div>

  <% end %>
</div>
